// SPDX-License-Identifier: (GPL-2.0-or-later OR MIT)
/*
 * Copyright (c) 2021 Rockchip Electronics Co., Ltd.
 * Copyright (c) 2024 Uwe Kleine-KÃ¶nig
 * Copyright (c) 2025 Ahmad Fatoum
 */


/dts-v1/;

#include <arm64/rockchip/rk3568-qnap-tsx33.dtsi>
#include "rk356x.dtsi"

/ {
	model = "Qnap TS-433eU-4G NAS Rackmount";
	compatible = "qnap,ts433eu", "rockchip,rk3568";

	vcc3v3_pcie: regulator-vcc3v3-pcie {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v3_pcie";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		enable-active-high;
		gpios = <&gpio0 RK_PD4 GPIO_ACTIVE_HIGH>;
		vin-supply = <&dc_12v>;
	};
};

&combphy2 {
	status = "okay";
};
&leds {
	led-1 {
		color = <LED_COLOR_ID_GREEN>;
		function = LED_FUNCTION_DISK;
		gpios = <&gpio1 RK_PD6 GPIO_ACTIVE_LOW>;
		label = "hdd2:green:disk";
		linux,default-trigger = "disk-activity";
		pinctrl-names = "default";
		pinctrl-0 = <&hdd2_led_pin>;
	};

	led-2 {
		color = <LED_COLOR_ID_GREEN>;
		function = LED_FUNCTION_DISK;
		gpios = <&gpio1 RK_PD7 GPIO_ACTIVE_LOW>;
		label = "hdd3:green:disk";
		linux,default-trigger = "disk-activity";
		pinctrl-names = "default";
		pinctrl-0 = <&hdd3_led_pin>;
	};

	led-3 {
		color = <LED_COLOR_ID_GREEN>;
		function = LED_FUNCTION_DISK;
		gpios = <&gpio2 RK_PA0 GPIO_ACTIVE_LOW>;
		label = "hdd4:green:disk";
		linux,default-trigger = "disk-activity";
		pinctrl-names = "default";
		pinctrl-0 = <&hdd4_led_pin>;
	};
};

&mcu {
	compatible = "qnap,ts433-mcu";
};

&pcie30phy {
	data-lanes = <1 2>;
	status = "okay";
};

/* Connected to RTL8125 */
&pcie2x1 {
	reset-gpios = <&gpio2 RK_PD6 GPIO_ACTIVE_HIGH>;
	vpcie3v3-supply = <&vcc3v3_pcie>;
	status = "okay";
};

/* Connected to RTL8125 */
&pcie3x1 {
	reset-gpios = <&gpio3 RK_PA1 GPIO_ACTIVE_HIGH>;
	vpcie3v3-supply = <&vcc3v3_pcie>;
	status = "okay";
};

/* Connected to ASM1064 SATA Controller */
&pcie3x2 {
	num-lanes = <1>;
	reset-gpios = <&gpio0 RK_PC7 GPIO_ACTIVE_HIGH>;
	vpcie3v3-supply = <&vcc3v3_pcie>;
	status = "okay";
};

/* Internal SATA controllers not used, ASM1064 used instead */
&sata1 {
	status = "disabled";
};

&pinctrl {
	leds {
		hdd2_led_pin: hdd2-led-pin {
			rockchip,pins = <1 RK_PD6 RK_FUNC_GPIO &pcfg_pull_up>;
		};

		hdd3_led_pin: hdd3-led-pin {
			rockchip,pins = <1 RK_PD7 RK_FUNC_GPIO &pcfg_pull_up>;
		};

		hdd4_led_pin: hdd4_led-pin {
			rockchip,pins = <2 RK_PA0 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};
};

&usb2phy1 {
	status = "okay";
};

/* connected to usb_host1_ehci/ohci */
&usb2phy1_host {
	phy-supply = <&vcc5v0_host>;
	status = "okay";
};

/* connected to usb_host0_ehci/ohci */
&usb2phy1_otg {
	phy-supply = <&vcc5v0_host>;
	status = "okay";
};

&usb_host0_ehci {
	status = "okay";
};

&usb_host0_ohci {
	status = "okay";
};

&usb_host1_ehci {
	status = "okay";
};

&usb_host1_ohci {
	status = "okay";
};

&usb_host0_xhci {
	/*
	 * This USB-A port is used by MaskROM for recovery and by barebox
	 * to provide fastboot and other gadgets, so we configure it as otg
	 * and expect users to explicitly set otg.mode=peripheral or =host.
	 */
	barebox,dr_mode = "otg";
};

/* Otherwise, I/O errors both in barebox and Linux.. */
&sdhci {
	max-frequency = <52000000>;
};
